#!/bin/sh

# File managed by puppet

if [ -f /var/run/$0.lock ]; then
  echo "$0 is already running!"
  exit 1
fi
lockfile-create /var/run/$0
lockfile-touch /var/run/$0 &
LOCKER="$!"


src='/etc/openvpn/ca/distrib /etc/openvpn/ca/keys /srv/computations /srv/misc /srv/xapian'
dst='gestepc3.epfl.ch'
day=$(date +'%d')

for i in $src; do
  rsync -e "ssh -i /root/.ssh/id_rsa-ldapsync" -ah --delete --log-file /var/log/sync-datas/sync-${day}.log $i root@${dst}:$(dirname $i)/
done

kill "$LOCKER" &>/dev/null
lockfile-remove /var/run/$0 &>/dev/null

