#!/usr/bin/env python
import sys,os,subprocess,grp
from pwd import getpwnam

devnull = open('/dev/null','a')

print '''Stop webclient'''
try:
  p = subprocess.Popen(['/etc/init.d/openerp-web-qa','stop'], stdout=devnull)
  p.wait()
except:
  print '''No such process'''
  pass

print '''Stop integration instance'''
try:
  p = subprocess.Popen(['/srv/openerp/openerp-admin.py','--stop','qa'],stdout=devnull)
  p.wait()
except:
  print '''no such process'''
  pass

# use postgres user..
_postgres = grp.getgrnam('postgres')
os.setegid(_postgres.gr_gid)
os.seteuid(getpwnam('postgres')[2])

print '''Remove QA database'''
p = subprocess.Popen(['dropdb','openerp_qa<%=openerp_project%>'], stdout=devnull, stderr=devnull)
p.wait()

print '''Create brand new database'''
p = subprocess.Popen(['createdb','-O','openerp_qa', '-T', 'template0', '-E','UNICODE','openerp_qa<%=openerp_project%>'], stdout=devnull, stderr=devnull
p.wait()

print '''Dump database from prod to integration'''
dump = subprocess.Popen(['/usr/bin/pg_dump', '-c', '-O', '-d', '-D', 'openerp_prod<%=openerp_project%>'], stdout=subprocess.PIPE, stderr=devnull)
p = subprocess.Popen(['/usr/bin/psql', 'openerp_qa<%=openerp_project%>', '-U', 'openerp_qa'], stdin=dump.stdout, stderr=devnull, stdout=devnull)
p.wait()

print '''Upgrade passwords'''
sql = subprocess.Popen(['echo','update', 'res_users', 'set', 'password','='"'qa_'||password;"], stdout=subprocess.PIPE,stderr=devnull)
p = subprocess.Popen(['/usr/bin/psql','openerp_qa<%=openerp_project%>'], stdin=sql.stdout, stderr=devnull, stdout=devnull)
p.wait()

# become root just to...
os.setegid(0)
os.seteuid(0)

# become openerp!
_openerp = grp.getgrnam('openerp')
os.setegid(_openerp.gr_gid)
os.seteuid(getpwnam('openerp')[2])

# rsync datas (yes, rsync, with good options)
print '''Sync files from Production to QA'''
for src in ['server','web-client','addons','extra-addons', 'specific-addons']:
  p = subprocess.Popen(['/usr/bin/rsync', '-a', '--delete', '/srv/openerp/instances/prod/src/%s'%src, '/srv/openerp/instances/qa/src/'])
  p.wait()

print '''Webclient: updating init file'''
lines = open('/srv/openerp/instances/qa/src/web-client/scripts/openerp-web','r').readlines()
out = ''
for line in lines:
  if line:
    if line == 'NAME=openerp-web':
      out += line.replace('NAME=openerp-web','NAME=openerp-web-qa')
    elif line == 'CONFIGFILE="/etc/openerp-web.cfg':
      out += line.replace('CONFIGFILE="/etc/openerp-web.cfg"','CONFIGFILE="/etc/openerp-web-qa.cfg"')
    else:
      out += line
file = open('/srv/openerp/instances/qa/src/web-client/scripts/openerp-web','w')
file.write(out)
file.close()

# become root for the last time.
os.setegid(0)
os.seteuid(0)

print '''Checking configurations...'''
p = subprocess.Popen(['/usr/sbin/puppetd','-t'],stdout=devnull, stderr=devnull)
p.wait()

print '''Restart QA instance'''
p = subprocess.Popen(['/srv/openerp/openerp-admin.py','--start','qa'], stdout=devnull)
p.wait()                                                                                                                                                                                                                      
                                                                                                                                                                                                                              
print '''Restart webclient'''
subprocess.Popen(['/etc/init.d/openerp-web-qa','start'], stdout=devnull)

# closing output
devnull.close()
sys.exit(0)

